// AutoLead.ai Database Schema
// Prisma ORM with PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum OrderStatus {
  NEW
  CONTACTED
  TEST_DRIVE_SCHEDULED
  TEST_DRIVE_DONE
  NEGOTIATION
  BOOKING_DONE
  FINANCING_PENDING
  FINANCING_APPROVED
  READY_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum OrderSource {
  WALK_IN
  WHATSAPP
  WEBSITE
  PHONE
  REFERRAL
}

enum FinancingStatus {
  PENDING
  APPROVED
  REJECTED
  CASH
}

enum RiskLevel {
  HIGH
  MEDIUM
  LOW
}

enum Channel {
  CALL
  WHATSAPP
  EMAIL
  IN_PERSON
  SYSTEM
}

enum Urgency {
  NOW
  TODAY
  THIS_WEEK
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum ActivityType {
  CALL_OUTBOUND
  CALL_INBOUND
  WHATSAPP_SENT
  WHATSAPP_RECEIVED
  EMAIL_SENT
  EMAIL_RECEIVED
  VISIT
  TEST_DRIVE
  STATUS_CHANGE
  NOTE
}

enum UserRole {
  SALESPERSON
  SALES_EXECUTIVE
  BRANCH_MANAGER
  CONTACT_CENTER
  ADMIN
  INSPECTOR
}

enum TradeInStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  PRICED
  ACCEPTED
  REJECTED
}

enum TestDriveStatus {
  DRAFT
  IDENTITY_VERIFIED
  VEHICLE_SELECTED
  AGREEMENT_SIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum VehicleCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum PhotoType {
  FRONT_VIEW
  REAR_VIEW
  LEFT_SIDE
  RIGHT_SIDE
  DASHBOARD
  FRONT_SEATS
  REAR_SEATS
  TRUNK
  ENGINE_BAY
  WHEELS
  ADDITIONAL_1
  ADDITIONAL_2
}

// ============================================
// MODELS
// ============================================

model User {
  id     String   @id @default(cuid())
  email  String   @unique
  name   String
  role   UserRole @default(SALESPERSON)
  avatar String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders     Order[]
  activities Activity[]

  // Trade-In Relations
  salesExecutiveAppraisals TradeInAppraisal[] @relation("SalesExecutiveAppraisals")
  inspectorAppraisals      TradeInAppraisal[] @relation("InspectorAppraisals")

  // Test Drive Relations
  testDrives TestDrive[]

  @@index([email])
  @@index([role])
}

model Customer {
  id               String   @id @default(cuid())
  name             String
  email            String?
  phone            String
  preferredChannel Channel?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders            Order[]
  tradeInAppraisals TradeInAppraisal[]
  testDrives        TestDrive[]

  @@index([phone])
  @@index([email])
}

model Vehicle {
  id      String  @id @default(cuid())
  make    String
  model   String
  variant String?
  year    Int
  color   String?
  vin     String? @unique

  // Inventory
  inStock            Boolean   @default(true)
  stockDate          DateTime?
  testDriveAvailable Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders     Order[]
  testDrives TestDrive[]

  @@index([make, model])
  @@index([vin])
}

model Order {
  id         String      @id @default(cuid())
  customerId String
  vehicleId  String
  status     OrderStatus @default(NEW)
  source     OrderSource

  // Dates
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  expectedDeliveryDate DateTime?
  deliveredAt          DateTime?

  // Financial
  totalAmount     Decimal         @db.Decimal(12, 2)
  bookingAmount   Decimal?        @db.Decimal(12, 2)
  financingStatus FinancingStatus @default(PENDING)

  // Assignment
  salespersonId String?

  // AI Computed Fields (cached for performance)
  riskScore              Int       @default(0)
  riskLevel              RiskLevel @default(LOW)
  fulfillmentProbability Int       @default(100)
  lastContactAt          DateTime?

  // Vehicle Configuration (Stock Search Selection)
  variantId       String?
  exteriorColorId String?
  interiorColorId String?
  vinNumber       String? @unique // Assigned when payment collected

  // Customer Portal
  portalActivated   Boolean   @default(false)
  portalActivatedAt DateTime?

  // Relations
  customer         Customer          @relation(fields: [customerId], references: [id])
  vehicle          Vehicle           @relation(fields: [vehicleId], references: [id])
  salesperson      User?             @relation(fields: [salespersonId], references: [id])
  activities       Activity[]
  priorityItems    PriorityItem[]
  paymentRequests  PaymentRequest[]
  discountRequests DiscountRequest[]
  quotations       Quotation[]

  @@index([customerId])
  @@index([vehicleId])
  @@index([salespersonId])
  @@index([status])
  @@index([riskLevel])
  @@index([createdAt])
  @@index([variantId])
}

model Activity {
  id      String       @id @default(cuid())
  orderId String
  type    ActivityType
  channel Channel

  // Content
  summary   String
  details   String?
  sentiment Sentiment?

  // Meta
  performedById String?
  performedAt   DateTime @default(now())
  duration      Int? // in seconds

  // AI-generated
  aiSummary           String?
  nextActionSuggested String?

  createdAt DateTime @default(now())

  // Relations
  order       Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  performedBy User? @relation(fields: [performedById], references: [id])

  @@index([orderId])
  @@index([performedById])
  @@index([performedAt])
  @@index([type])
}

model PriorityItem {
  id      String @id @default(cuid())
  orderId String

  // Priority
  rank        Int
  riskScore   Int
  riskLevel   RiskLevel
  riskFactors Json // Array of RiskFactor objects

  // Next Best Action
  nextBestAction Json // NextBestAction object

  // Meta
  generatedAt DateTime @default(now())
  expiresAt   DateTime

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([generatedAt])
  @@index([riskLevel])
}

// ============================================
// OPTIONAL: Branch/Dealership for multi-tenant
// ============================================

model Branch {
  id      String  @id @default(cuid())
  name    String
  code    String  @unique
  address String?
  phone   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  inventory VehicleInventory[]

  @@index([code])
}

// ============================================
// TRADE-IN PORTAL
// ============================================

model TradeInAppraisal {
  id     String        @id @default(cuid())
  status TradeInStatus @default(DRAFT)

  // Linked entities
  leadId           String?
  customerId       String
  salesExecutiveId String

  // Step 1: Registration Card Images
  registrationFrontUrl String?
  registrationBackUrl  String?

  // OCR Extracted Data (UAE Mulkiyah Fields)
  ocrCustomerName      String?
  ocrTrafficFileNumber String? // T.C. No. - unique identifier for traffic services
  ocrPlateNumber       String?
  ocrEmirateCode       String? // Emirate code (e.g., A, B, D for Dubai)
  ocrVin               String? // 17-digit chassis number
  ocrVehicleMake       String?
  ocrVehicleModel      String?
  ocrVehicleTrim       String?
  ocrVehicleColor      String?
  ocrVehicleType       String? // e.g., "Light Private Vehicle", "Public Transport"
  ocrEngineNumber      String? // For GCC spec vehicles
  ocrRegistrationYear  Int?
  ocrRegistrationDate  DateTime? // Initial registration date
  ocrExpiryDate        DateTime? // Mulkiyah expiry date
  ocrInsuranceCompany  String?
  ocrInsuranceExpiry   DateTime?
  ocrMortgageInfo      String? // Mortgage/lien details if financed

  // Step 2: Vehicle Details
  mileage         Int?
  expectedPrice   Decimal?          @db.Decimal(12, 2)
  condition       VehicleCondition?
  features        String[] // Array of feature strings
  additionalNotes String?

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime?

  // Inspector Review (Step 5)
  inspectorId    String?
  reviewedAt     DateTime?
  tentativePrice Decimal?  @db.Decimal(12, 2)
  inspectorNotes String?

  // Relations
  customer       Customer       @relation(fields: [customerId], references: [id])
  salesExecutive User           @relation("SalesExecutiveAppraisals", fields: [salesExecutiveId], references: [id])
  inspector      User?          @relation("InspectorAppraisals", fields: [inspectorId], references: [id])
  photos         TradeInPhoto[]

  @@index([customerId])
  @@index([salesExecutiveId])
  @@index([inspectorId])
  @@index([status])
  @@index([createdAt])
}

model TradeInPhoto {
  id          String    @id @default(cuid())
  appraisalId String
  type        PhotoType
  url         String
  thumbnail   String?
  notes       String?
  annotations Json? // Array of annotation objects

  createdAt DateTime @default(now())

  // Relations
  appraisal TradeInAppraisal @relation(fields: [appraisalId], references: [id], onDelete: Cascade)

  @@index([appraisalId])
  @@index([type])
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  TRADE_IN_PRICED
  TRADE_IN_ACCEPTED
  TRADE_IN_REJECTED
  ORDER_STATUS_CHANGE
  TEST_DRIVE_SCHEDULED
  TEST_DRIVE_COMPLETED
  TEST_DRIVE_FEEDBACK_REQUEST
  TEST_DRIVE_FEEDBACK_RECEIVED
  SYSTEM
}

enum BuyingIntent {
  HIGH
  MEDIUM
  LOW
  UNDETERMINED
}

enum FeedbackStatus {
  PENDING
  RECORDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

model Notification {
  id      String           @id @default(cuid())
  userId  String // Recipient
  type    NotificationType
  title   String
  message String
  link    String? // URL to navigate to
  read    Boolean          @default(false)

  // Reference to related entity
  referenceId   String? // ID of related trade-in, order, etc.
  referenceType String? // "trade-in", "order", etc.

  createdAt DateTime  @default(now())
  readAt    DateTime?

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
}

// ============================================
// TEST DRIVE
// ============================================

model TestDrive {
  id     String          @id @default(cuid())
  status TestDriveStatus @default(DRAFT)

  // Relationships
  customerId       String
  salesExecutiveId String
  vehicleId        String
  orderId          String? // Optional link to order

  // Identity Documents - Driving License
  drivingLicenseFrontUrl String?
  drivingLicenseBackUrl  String?

  // Identity Documents - National ID (Emirates ID)
  nationalIdFrontUrl String?
  nationalIdBackUrl  String?

  // OCR Extracted Data - Driving License
  ocrFullName        String?
  ocrLicenseNumber   String?
  ocrLicenseExpiry   DateTime?
  ocrDateOfBirth     DateTime?
  ocrNationality     String?
  ocrLicenseCategory String?

  // OCR Extracted Data - National ID (Emirates ID)
  ocrEmiratesIdNumber String?
  ocrNationalIdExpiry DateTime?
  ocrNationalIdNameEn String?
  ocrNationalIdNameAr String?

  // Booking Details
  scheduledDate DateTime?
  scheduledTime String? // "14:00"
  duration      Int       @default(30) // minutes

  // Agreement
  agreementUrl  String?
  signatureUrl  String?
  signedAt      DateTime?
  termsVersion  String?
  termsAccepted Boolean   @default(false)

  // Vehicle Lock
  vehicleLockedAt    DateTime?
  vehicleLockExpires DateTime?

  // Email Confirmation
  confirmationEmailSent   Boolean   @default(false)
  confirmationEmailSentAt DateTime?

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  outcome     String?
  notes       String?

  // Relations
  customer       Customer            @relation(fields: [customerId], references: [id])
  salesExecutive User                @relation(fields: [salesExecutiveId], references: [id])
  vehicle        Vehicle             @relation(fields: [vehicleId], references: [id])
  auditLogs      TestDriveAuditLog[]
  feedback       TestDriveFeedback?

  @@index([customerId])
  @@index([salesExecutiveId])
  @@index([vehicleId])
  @@index([status])
  @@index([scheduledDate])
  @@index([vehicleLockedAt])
  @@index([createdAt])
}

model AgreementTerms {
  id          String   @id @default(cuid())
  version     String   @unique // "1.0", "1.1"
  content     String   @db.Text
  isActive    Boolean  @default(false)
  effectiveAt DateTime

  createdAt DateTime @default(now())

  @@index([isActive])
  @@index([effectiveAt])
}

model TestDriveAuditLog {
  id          String  @id @default(cuid())
  testDriveId String
  action      String // CREATED, IDENTITY_VERIFIED, VEHICLE_SELECTED, SIGNED, COMPLETED, etc.
  details     Json    @default("{}")
  performedBy String?
  ipAddress   String?
  userAgent   String? @db.Text

  timestamp DateTime @default(now())

  // Relations
  testDrive TestDrive @relation(fields: [testDriveId], references: [id], onDelete: Cascade)

  @@index([testDriveId])
  @@index([action])
  @@index([timestamp])
}

// ============================================
// TEST DRIVE VOICE FEEDBACK
// ============================================

model TestDriveFeedback {
  id          String         @id @default(cuid())
  testDriveId String         @unique
  status      FeedbackStatus @default(PENDING)

  // Voice Recording
  voiceUrl      String? // URL to stored audio file
  voiceDuration Int? // Duration in seconds
  recordedAt    DateTime?

  // AI Transcription
  transcript       String? @db.Text
  detectedLanguage String? // "en", "ar", etc.

  // AI Sentiment Analysis
  overallSentiment Sentiment?
  sentimentScore   Float? // -1 to 1 scale
  emotionTags      String[] // ["excited", "hesitant", "satisfied"]

  // AI Insight Extraction
  keyPositives      String[] // ["Loved the driving feel", "Great acceleration"]
  mainObjections    String[] // ["Concern about rear space", "Price too high"]
  buyingIntent      BuyingIntent @default(UNDETERMINED)
  buyingIntentScore Float? // 0 to 100

  // AI Sales Recommendation
  recommendedAction     String? // "Offer alternative variant"
  recommendedActionType String? // "OFFER_VARIANT", "FINANCE_OFFER", "SEND_INFO", "FOLLOW_UP"
  actionRationale       String? // Why this action is recommended

  // Deal Intelligence
  closeProbabilityBefore Int? // Before feedback
  closeProbabilityAfter  Int? // After feedback analysis
  probabilityDelta       Int? // Change in probability

  // Raw AI Response (for debugging/audit)
  aiAnalysisRaw Json?

  // Feedback Request Tracking
  feedbackRequestSentAt  DateTime?
  feedbackRequestChannel String? // "whatsapp", "sms", "portal"
  feedbackLinkAccessedAt DateTime?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  // Relations
  testDrive TestDrive @relation(fields: [testDriveId], references: [id], onDelete: Cascade)

  @@index([testDriveId])
  @@index([status])
  @@index([buyingIntent])
  @@index([createdAt])
}

// ============================================
// STOCK SEARCH, ORDER MANAGEMENT & DISCOUNT WORKFLOW
// ============================================

// ============================================
// BRAND & MODEL HIERARCHY
// ============================================

model Brand {
  id      String  @id @default(cuid())
  name    String  @unique // "Toyota", "BMW"
  logoUrl String?
  code    String  @unique

  // Discount Rules - JSON array of { maxAmount: number, requiredLevel: number }
  discountRules Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  models VehicleModel[]

  @@index([code])
}

model VehicleModel {
  id      String @id @default(cuid())
  brandId String
  name    String // "Camry", "X5"
  code    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  brand    Brand            @relation(fields: [brandId], references: [id])
  variants VehicleVariant[]

  @@unique([brandId, code])
  @@index([brandId])
}

model VehicleVariant {
  id      String @id @default(cuid())
  modelId String
  name    String // "XLE", "M Sport"
  code    String
  year    Int

  // Pricing
  msrp         Decimal  @db.Decimal(12, 2)
  currentPrice Decimal  @db.Decimal(12, 2)
  dealerCost   Decimal? @db.Decimal(12, 2)

  // Specs
  engineType   String?
  transmission String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  model             VehicleModel       @relation(fields: [modelId], references: [id])
  inventory         VehicleInventory[]
  colorCombinations ColorCombination[]
  campaigns         CampaignVariant[]

  @@unique([modelId, code, year])
  @@index([modelId])
  @@index([year])
}

model VehicleColor {
  id       String @id @default(cuid())
  name     String // "Pearl White"
  code     String @unique
  hexColor String // "#F5F5F5"
  category String // "EXTERIOR" | "INTERIOR"

  createdAt DateTime @default(now())

  exteriorCombinations ColorCombination[] @relation("ExteriorColor")
  interiorCombinations ColorCombination[] @relation("InteriorColor")
  inventory            VehicleInventory[]
}

model ColorCombination {
  id              String  @id @default(cuid())
  variantId       String
  exteriorColorId String
  interiorColorId String
  isAvailable     Boolean @default(true)
  imageUrl        String?

  variant       VehicleVariant @relation(fields: [variantId], references: [id])
  exteriorColor VehicleColor   @relation("ExteriorColor", fields: [exteriorColorId], references: [id])
  interiorColor VehicleColor   @relation("InteriorColor", fields: [interiorColorId], references: [id])

  @@unique([variantId, exteriorColorId, interiorColorId])
  @@index([variantId])
}

// ============================================
// INVENTORY
// ============================================

enum StockStatus {
  IN_TRANSIT
  IN_YARD
  RESERVED
  SOLD
  DAMAGED
}

model VehicleInventory {
  id              String  @id @default(cuid())
  vin             String  @unique
  variantId       String
  exteriorColorId String
  interiorColorId String?
  branchId        String?

  status       StockStatus @default(IN_TRANSIT)
  locationCode String?

  stockDate     DateTime
  etaDate       DateTime?
  reservedUntil DateTime?

  // Linked order
  orderId    String? @unique
  reservedBy String?

  // AI Scoring
  agingDays         Int @default(0)
  agingRiskScore    Int @default(0)
  closeabilityScore Int @default(50)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variant       VehicleVariant @relation(fields: [variantId], references: [id])
  exteriorColor VehicleColor   @relation(fields: [exteriorColorId], references: [id])
  branch        Branch?        @relation(fields: [branchId], references: [id])

  @@index([variantId])
  @@index([status])
  @@index([stockDate])
  @@index([branchId])
}

// ============================================
// CAMPAIGNS & OFFERS
// ============================================

enum CampaignType {
  DISCOUNT
  CASHBACK
  FINANCING
  ACCESSORY_BUNDLE
  TRADE_IN_BONUS
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  EXPIRED
}

model Campaign {
  id          String         @id @default(cuid())
  name        String
  code        String         @unique
  description String?
  type        CampaignType
  status      CampaignStatus @default(DRAFT)

  startDate DateTime
  endDate   DateTime

  discountType  String? // "PERCENTAGE" | "FIXED"
  discountValue Decimal? @db.Decimal(12, 2)

  totalRedemptions Int     @default(0)
  totalSalesValue  Decimal @default(0) @db.Decimal(15, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variants CampaignVariant[]

  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model CampaignVariant {
  id               String   @id @default(cuid())
  campaignId       String
  variantId        String
  overrideDiscount Decimal? @db.Decimal(12, 2)

  campaign Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  variant  VehicleVariant @relation(fields: [variantId], references: [id])

  @@unique([campaignId, variantId])
  @@index([campaignId])
  @@index([variantId])
}

// ============================================
// ORDER ENHANCEMENTS - Payment, Discount, Quotation
// ============================================

enum PaymentType {
  DOWN_PAYMENT
  FULL_PAYMENT
  INSTALLMENT
  REFUND
}

enum PaymentStatus {
  PENDING
  REQUESTED
  COMPLETED
  FAILED
  REFUNDED
}

enum DiscountStatus {
  DRAFT
  PENDING_BM // Pending Branch Manager
  PENDING_GM // Pending General Manager
  APPROVED
  REJECTED
}

enum QuotationStatus {
  DRAFT
  ISSUED
  SENT
  ACCEPTED
  EXPIRED
  CANCELLED
}

model PaymentRequest {
  id      String        @id @default(cuid())
  orderId String
  type    PaymentType
  status  PaymentStatus @default(PENDING)

  amount   Decimal @db.Decimal(12, 2)
  currency String  @default("AED")

  // Payment details
  paymentMethod String? // "CARD", "BANK_TRANSFER", "CASH"
  reference     String? // External payment reference
  paidAt        DateTime?

  // Request tracking
  requestedBy String
  requestedAt DateTime  @default(now())
  processedBy String?
  processedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
}

model DiscountRequest {
  id      String         @id @default(cuid())
  orderId String
  status  DiscountStatus @default(DRAFT)

  // Pricing
  originalPrice     Decimal @db.Decimal(12, 2)
  campaignDiscount  Decimal @default(0) @db.Decimal(12, 2)
  requestedDiscount Decimal @db.Decimal(12, 2)
  finalPrice        Decimal @db.Decimal(12, 2)

  // Justification
  justification String @db.Text

  // Approval workflow
  currentLevel  Int @default(1) // 1=BM, 2=GM
  requiredLevel Int @default(1)

  // Timestamps
  requestedBy String
  requestedAt DateTime @default(now())

  // BM Approval
  bmApprovedBy String?
  bmApprovedAt DateTime?
  bmComment    String?

  // GM Approval (if required)
  gmApprovedBy String?
  gmApprovedAt DateTime?
  gmComment    String?

  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([requestedAt])
}

model Quotation {
  id      String          @id @default(cuid())
  orderId String
  status  QuotationStatus @default(DRAFT)

  // Content
  quotationNumber String @unique

  // Pricing snapshot
  vehiclePrice       Decimal @db.Decimal(12, 2)
  campaignDiscount   Decimal @default(0) @db.Decimal(12, 2)
  additionalDiscount Decimal @default(0) @db.Decimal(12, 2)
  accessories        Decimal @default(0) @db.Decimal(12, 2)
  fees               Decimal @default(0) @db.Decimal(12, 2)
  totalAmount        Decimal @db.Decimal(12, 2)

  // Validity
  validUntil DateTime

  // PDF
  pdfUrl String?

  // DMS Integration
  dmsQuotationId String? // External reference
  dmsSyncedAt    DateTime?

  // Tracking
  issuedBy   String
  issuedAt   DateTime  @default(now())
  sentAt     DateTime?
  acceptedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([quotationNumber])
}

// ============================================
// STOCK INTELLIGENCE
// ============================================

model StockMetrics {
  id       String   @id @default(cuid())
  date     DateTime @db.Date
  branchId String?

  totalUnits     Int
  inTransitUnits Int
  inYardUnits    Int
  reservedUnits  Int

  units0to30Days  Int
  units31to60Days Int
  units61to90Days Int
  unitsOver90Days Int

  totalStockValue  Decimal @db.Decimal(15, 2)
  atRiskStockValue Decimal @db.Decimal(15, 2)

  avgDaysToSale Float
  turnoverRate  Float

  createdAt DateTime @default(now())

  @@unique([date, branchId])
  @@index([date])
  @@index([branchId])
}

model ColorDemandAnalysis {
  id              String   @id @default(cuid())
  variantId       String
  exteriorColorId String
  month           DateTime @db.Date

  inquiryCount   Int @default(0)
  testDriveCount Int @default(0)
  orderCount     Int @default(0)
  deliveryCount  Int @default(0)

  avgStockLevel Float @default(0)
  stockouts     Int   @default(0)

  demandScore   Int @default(50)
  supplyScore   Int @default(50)
  mismatchScore Int @default(0)

  createdAt DateTime @default(now())

  @@unique([variantId, exteriorColorId, month])
  @@index([variantId])
  @@index([exteriorColorId])
}
