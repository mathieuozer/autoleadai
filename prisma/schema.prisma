// AutoLead.ai Database Schema
// Prisma ORM with PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum OrderStatus {
  NEW
  CONTACTED
  TEST_DRIVE_SCHEDULED
  TEST_DRIVE_DONE
  NEGOTIATION
  BOOKING_DONE
  FINANCING_PENDING
  FINANCING_APPROVED
  READY_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum OrderSource {
  WALK_IN
  WHATSAPP
  WEBSITE
  PHONE
  REFERRAL
}

enum FinancingStatus {
  PENDING
  APPROVED
  REJECTED
  CASH
}

enum RiskLevel {
  HIGH
  MEDIUM
  LOW
}

enum Channel {
  CALL
  WHATSAPP
  EMAIL
  IN_PERSON
  SYSTEM
}

enum Urgency {
  NOW
  TODAY
  THIS_WEEK
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum ActivityType {
  CALL_OUTBOUND
  CALL_INBOUND
  WHATSAPP_SENT
  WHATSAPP_RECEIVED
  EMAIL_SENT
  EMAIL_RECEIVED
  VISIT
  TEST_DRIVE
  STATUS_CHANGE
  NOTE
}

enum UserRole {
  SALESPERSON
  SALES_EXECUTIVE
  BRANCH_MANAGER
  CONTACT_CENTER
  ADMIN
  INSPECTOR
}

enum TradeInStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  PRICED
  ACCEPTED
  REJECTED
}

enum VehicleCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum PhotoType {
  FRONT_VIEW
  REAR_VIEW
  LEFT_SIDE
  RIGHT_SIDE
  DASHBOARD
  FRONT_SEATS
  REAR_SEATS
  TRUNK
  ENGINE_BAY
  WHEELS
  ADDITIONAL_1
  ADDITIONAL_2
}

// ============================================
// MODELS
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      UserRole @default(SALESPERSON)
  avatar    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders     Order[]
  activities Activity[]

  // Trade-In Relations
  salesExecutiveAppraisals TradeInAppraisal[] @relation("SalesExecutiveAppraisals")
  inspectorAppraisals      TradeInAppraisal[] @relation("InspectorAppraisals")

  @@index([email])
  @@index([role])
}

model Customer {
  id               String   @id @default(cuid())
  name             String
  email            String?
  phone            String
  preferredChannel Channel?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders           Order[]
  tradeInAppraisals TradeInAppraisal[]

  @@index([phone])
  @@index([email])
}

model Vehicle {
  id      String  @id @default(cuid())
  make    String
  model   String
  variant String?
  year    Int
  color   String?
  vin     String? @unique

  // Inventory
  inStock   Boolean @default(true)
  stockDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders Order[]

  @@index([make, model])
  @@index([vin])
}

model Order {
  id         String          @id @default(cuid())
  customerId String
  vehicleId  String
  status     OrderStatus     @default(NEW)
  source     OrderSource

  // Dates
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  expectedDeliveryDate DateTime?
  deliveredAt          DateTime?

  // Financial
  totalAmount     Decimal         @db.Decimal(12, 2)
  bookingAmount   Decimal?        @db.Decimal(12, 2)
  financingStatus FinancingStatus @default(PENDING)

  // Assignment
  salespersonId String?

  // AI Computed Fields (cached for performance)
  riskScore              Int     @default(0)
  riskLevel              RiskLevel @default(LOW)
  fulfillmentProbability Int     @default(100)
  lastContactAt          DateTime?

  // Relations
  customer    Customer   @relation(fields: [customerId], references: [id])
  vehicle     Vehicle    @relation(fields: [vehicleId], references: [id])
  salesperson User?      @relation(fields: [salespersonId], references: [id])
  activities  Activity[]
  priorityItems PriorityItem[]

  @@index([customerId])
  @@index([vehicleId])
  @@index([salespersonId])
  @@index([status])
  @@index([riskLevel])
  @@index([createdAt])
}

model Activity {
  id      String       @id @default(cuid())
  orderId String
  type    ActivityType
  channel Channel

  // Content
  summary   String
  details   String?
  sentiment Sentiment?

  // Meta
  performedById String?
  performedAt   DateTime @default(now())
  duration      Int?     // in seconds

  // AI-generated
  aiSummary           String?
  nextActionSuggested String?

  createdAt DateTime @default(now())

  // Relations
  order       Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  performedBy User? @relation(fields: [performedById], references: [id])

  @@index([orderId])
  @@index([performedById])
  @@index([performedAt])
  @@index([type])
}

model PriorityItem {
  id      String @id @default(cuid())
  orderId String

  // Priority
  rank       Int
  riskScore  Int
  riskLevel  RiskLevel
  riskFactors Json // Array of RiskFactor objects

  // Next Best Action
  nextBestAction Json // NextBestAction object

  // Meta
  generatedAt DateTime @default(now())
  expiresAt   DateTime

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([generatedAt])
  @@index([riskLevel])
}

// ============================================
// OPTIONAL: Branch/Dealership for multi-tenant
// ============================================

model Branch {
  id       String @id @default(cuid())
  name     String
  code     String @unique
  address  String?
  phone    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

// ============================================
// TRADE-IN PORTAL
// ============================================

model TradeInAppraisal {
  id     String        @id @default(cuid())
  status TradeInStatus @default(DRAFT)

  // Linked entities
  leadId           String?
  customerId       String
  salesExecutiveId String

  // Step 1: Registration Card Images
  registrationFrontUrl String?
  registrationBackUrl  String?

  // OCR Extracted Data
  ocrCustomerName    String?
  ocrVehicleMake     String?
  ocrVehicleModel    String?
  ocrVehicleTrim     String?
  ocrVin             String?
  ocrPlateNumber     String?
  ocrRegistrationYear Int?

  // Step 2: Vehicle Details
  mileage         Int?
  expectedPrice   Decimal?        @db.Decimal(12, 2)
  condition       VehicleCondition?
  features        String[]        // Array of feature strings
  additionalNotes String?

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime?

  // Inspector Review (Step 5)
  inspectorId     String?
  reviewedAt      DateTime?
  tentativePrice  Decimal?  @db.Decimal(12, 2)
  inspectorNotes  String?

  // Relations
  customer       Customer         @relation(fields: [customerId], references: [id])
  salesExecutive User             @relation("SalesExecutiveAppraisals", fields: [salesExecutiveId], references: [id])
  inspector      User?            @relation("InspectorAppraisals", fields: [inspectorId], references: [id])
  photos         TradeInPhoto[]

  @@index([customerId])
  @@index([salesExecutiveId])
  @@index([inspectorId])
  @@index([status])
  @@index([createdAt])
}

model TradeInPhoto {
  id          String    @id @default(cuid())
  appraisalId String
  type        PhotoType
  url         String
  thumbnail   String?
  notes       String?
  annotations Json?     // Array of annotation objects

  createdAt DateTime @default(now())

  // Relations
  appraisal TradeInAppraisal @relation(fields: [appraisalId], references: [id], onDelete: Cascade)

  @@index([appraisalId])
  @@index([type])
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  TRADE_IN_PRICED
  TRADE_IN_ACCEPTED
  TRADE_IN_REJECTED
  ORDER_STATUS_CHANGE
  SYSTEM
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           // Recipient
  type      NotificationType
  title     String
  message   String
  link      String?          // URL to navigate to
  read      Boolean          @default(false)

  // Reference to related entity
  referenceId   String?      // ID of related trade-in, order, etc.
  referenceType String?      // "trade-in", "order", etc.

  createdAt DateTime @default(now())
  readAt    DateTime?

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
}
